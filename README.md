# Урок 30
Для начала работы скопируйте репозиторий на локальную машину с помощью команды в терминале:

`git clone https://github.com/skypro-008/lesson30-and-tests.git`

Откройте с клонированный репозиторий в PyCharm.

### Создайте виртуальное окружение:

#### Простой вариант:
Pycharm может предложить вам сделать это после того, как вы откроете папку с проектом.
В этом случае после открытия папки с проектом в PyCharm.
Появляется всплывающее окно, Creating virtual environment c тремя полями.
В первом поле выбираем размещение папки с виртуальным окружением, как правило, это папка venv
в корне проекта
Во втором поле выбираем устанавливаемый интерпретатор по умолчанию (можно оставить без изменений)
В 3 поле выбираем список зависимостей (должен быть выбран файл requirements.txt, 
находящийся в корне папки проекта)

#### Если этого не произошло, тогда следует выполнить следующие действия вручную:
#### Установка виртуального окружения:
1. Во вкладке File выберите пункт Settings
2. В открывшемся окне, с левой стороны найдите вкладку с именем
вашего репозитория (Project: lesson30-and-tests)
3. В выбранной вкладке откройте настройку Python Interpreter
4. В открывшейся настройке кликните на значок ⚙ (шестеренки) 
расположенный сверху справа и выберите опцию Add
5. В открывшемся окне слева выберите Virtualenv Environment, 
а справа выберите New Environment и нажмите ОК

#### Установка зависимостей:
Для этого можно воспользоваться графическим интерфейсом PyCharm,
который вам предложит сделать это как только вы откроете файл с заданием.

Или же вы можете сделать это вручную, выполнив следующую команду в терминале:
`pip install -r requirements.txt`

*У владельцев операционной системы MacOS могут возниктут сложности с установкой зависимостей.
Если возникла ошибка - сначала выполните в терминале команду brew install postgresql.
После её выполнения ошибок с установкой зависимостей быть не должно.
#### Настройка виртуального окружения завершена!
### Подготовка проекта django
После того как Вы установили все зависимости, необходимо подготовить django к работе:
для этого нам потребуется:

1. Иметь возможность запуска на локальной машине docker-контейнера 
(необходимо для запуска контейнера с базы данных):
- переходим в каталог `postgres_l30` и выполняем команду `docker-compose up --build`.
- В этой части тренажера также можно воспользоваться командами 
- `make clean` и `make up_database` о которых рассказывается ниже.

2. Выполнить необходимые команды для подготовки базы данных к работе:
Текущий проект уже содержит настроенную базу данных, но пока еще она 
пустая, не содержит таблиц, а всё её наполнение
находится в фикстурах (в django - файлы в формате json содержащие данные для наполнения БД).

В первой части тренажера команду `python3 manage.py makemigrations` и `python3 manage.py migrate`
выполнять не нужно, так как нам предстоит работа с кастомными модеями пользователей и в этом случае
миграции выполняются после того, как новые модели пользователей созданы.
Подробнее об этом можно узнать [здесь](https://docs.djangoproject.com/en/4.0/topics/auth/customizing/#using-a-custom-user-model-when-starting-a-project).


### Порядок выполнения заданий

## Часть 1
Первая часть тренажера состоит из следующих проектов:
Проект1: custom_user_1 (задание custom_user_1)
Проект2: custom_user_2 (задание custom_user_2)
Проект3: register_login(задания register, login)
Проект4: register_jwt_token(задние jwt_token)

В этой части нам пришлось создать несколько баз данных в одном postgres-контейнере, так как
в проекте Джанго модель пользователя должна быть только одна и для нее должна быть отдельная база данных.
*Если что-то пошло не так и Вам нужно обнулить базы данных - можно воспользоваться командами из корня папки с заданием*
`make clean` - для очистки всех баз данных
`make up_database` - для запуска баз данных еще раз
Однако в первое время все же советуем Вам использовать для этого стандартные команды докера.

*Обратите внимание, что часть адресов, представленных в заданиях ниже уже реализованы
и здесь Вам требуется только дополнить их соответствующим образом.*

### Задание custom_user_1 (ПРОЕКТ custom_user_1)
Перейдите в файл models приложения custom_user_1.
Напишите профиль юзера, который будет храниться в отдельной от пользователя таблице. 
В профиле будет храниться информация об адресе (максимум 50 символов) 
и сотовом телефоне пользователя в формате 8-999-999999.

### Задание custom_user_2 (ПРОЕКТ custom_user_2)
Напишите своего пользователя, добавив в основную модель поля:
role (значения: “teacher”, “student”),
birth_date (дата рождения)

### Задание register (ПРОЕКТ register_login)
Перейдите в приложение register проекта register_login
В приложении register опишите вью и serializer для создания пользователя.

### Задание login (ПРОЕКТ register_login)
Перейдите в приложение login проекта register_login и
в файле urls.py создайте эндпоинт `/login/` для получения токена для зарегистрированного пользователя.

### Задание jwt_token (ПРОЕКТ register_jwt_token)
Перейдите в приложение login проекта register_jwt_token и
в файле urls.py создайте несколько эндпоинтов:
- `/token/` для получения access и refresh токена для зарегистрированного пользователя.
- `/token/refresh/` для обновления access токена.
Перед тем как получить токен, не забудьте сначала зарегистрировать пользователя.
Это можно сделать с помощью эндпоинта `/register/`

## Часть 2
Вторая часть тренажера состоит из следующих проектов:
Проект5: authorization (задание store_list, store_update)
Проект6: diary(задание diary)
Проект7: sky_ad(задние sky_ad)

### Задание store_list (ПРОЕКТ authorization)
Перейдите в приложение store_list в проекте authorization.
И измените класс StoreListView так, чтобы при GET-запросе на адрес `/store_list/` 
список магазинов был доступен только авторизованным пользователям.
Для корректного выполения задания подготовьте, пожалуйста миграции, а также выполните команду
`python3 manage.py loadall` для загрузки фикстур.
Кроме того, незабудьте зарегистрировать нового пользователя с помощью POST- запроса на адрес /register/
Данный запрос должен содержать json вида:

```json
{
  "username": "username",
  "password": "password",
  "email": "email@example.com",
  "store": "test_store"
}
```
Проверить все задания проекта вы можете с помощью команды `python3 manage.py test`
Проверить только одно задание проекта можно с помощью команды `python3 manage.py test <app>

### Задание store_update (ПРОЕКТ authorization)
Перейдите в приложение store_update в проекте authorization.
У вас есть View на обновление данных о магазине. 
Внимательно почитайте документацию DRF по классам Permission и 
настройте View так, чтобы чтобы при GET-запросе на адрес `/store_update/` 
изменять данные могли только администраторы. 
Для реализации воспользуйтесь встроенными возможностями DRF.

Проверить все задания проекта вы можете с помощью команды `python3 manage.py test`
Проверить только одно задание проекта можно с помощью команды `python3 manage.py test <app>`

### Задание diary (ПРОЕКТ diary)
Мы написали электронный дневник, и теперь надо 
ограничить доступ к изменениям оценок. 
Посмотрите внимательно на модель пользователя и допишите View так, 
чтобы оценки мог ставить только преподаватель (teacher).
В этой задаче уже имеется два пользователя. Не забудьте загрузить их с помощью команды
python3 manage.py loadall

Для самопроверки:
Для того, чтобы использовать аккаунт учителя, воспользуйтесь
следующими данными:
```json
{
  "username": "teacher",
  "password": "skypro"
}
```

Аккаунт ученика имее следующие данные:
```json
{
  "username": "student",
  "password": "skypro"
}
```

Для того чтобы получить токен, 
используйте POST запрос на адрес `/login/`
с имеющимися данными

### Задание sky_ad (ПРОЕКТ sky_ad)
Перейдите приложение ad проекта sky_ad
И измените код в приложении таким образом, чтобы
изменять объявление мог только его владелец.
(при PATCH-запросе на адрес /ad/{id} возвращается статус 200)
Если же запись пытаеся изменить кто-либо другой - должен возвращаться статус 403
